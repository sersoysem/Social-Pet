<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Sohbet Odası</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #f5f6fa;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-wrapper {
            width: 90vw;
            min-height: 98vh;
            max-height: 98vh;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 6px 32px #ff6b3530;
            display: flex;
            flex-direction: column;
            margin: 8px 0;
            overflow: hidden;
        }
        .chat-header {
            background: #ff6b35;
            color: #fff;
            padding: 17px 18px 14px 12px;
            font-size: 1.36rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }
        .chat-back {
            background: rgba(255,255,255,0.92);
            color: #ff6b35;
            border: none;
            border-radius: 50%;
            width: 36px; height: 36px;
            font-size: 1.35rem;
            margin-right: 7px;
            cursor: pointer;
            box-shadow: 0 1px 7px #ff6b3522;
            transition: background .13s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-back:hover {
            background: #ffd6c6;
        }
        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff5;
        }
        .chat-header-info {
            display: flex;
            flex-direction: column;
        }
        .chat-header-name {
            font-weight: 700;
            font-size: 1.16rem;
            margin-bottom: -2px;
            letter-spacing: .1px;
        }
        .chat-header-email {
            font-size: 0.89rem;
            color: #ffe8d6;
            font-weight: 400;
            opacity: .95;
        }
        #messages {
            flex: 1;
            overflow-y: auto;
            background: #f7f8fa;
            padding: 12px 10px 16px 10px;
            min-height: 320px;
            max-height: 75vh;
        }
        .msg-row { display: flex; margin-bottom: 15px; align-items: flex-end; gap: 7px; margin-left: 10px; }
        .msg-row.me { flex-direction: row-reverse; }
        .msg-avatar {
            width: 38px; height: 38px; border-radius: 50%;
            background: #ffe2d2; border: 2px solid #ff6b35; object-fit: cover;
        }
        .msg-bubble {
            max-width: 72vw; min-width: 32px;
            padding: 10px 15px; border-radius: 18px;
            font-size: 1.04rem; background: #f2f2f7; color: #444;
            box-shadow: 0 2px 6px #ff6b3510; word-break: break-word;
        }
        .msg-row.me .msg-bubble { background: #ff6b35; color: #fff; border-bottom-right-radius: 6px; }
        .msg-row.them .msg-bubble { background: #ececec; color: #333; border-bottom-left-radius: 6px; }
        .msg-name { font-size: 0.96rem; color: #888; margin: 0 0 2px 3px; }
        .chat-form { display: flex; border-top: 1.5px solid #ffe5d3; padding: 10px; background: #fff; gap: 10px;}
        .chat-form input[type="text"] {
            flex: 1; padding: 12px 15px; border-radius: 18px; border: 1.5px solid #ffd2b2;
            font-size: 1.06rem; background: #f7f7f7; outline: none; transition: border 0.14s;
        }
        .chat-form button {
            background: #ff6b35; color: #fff; font-size: 1.08rem; border: none;
            padding: 0 22px; border-radius: 18px; cursor: pointer; transition: background 0.12s;
        }
        .chat-form button:hover { background: #e3562a; }
        @media (max-width: 600px) {
            .chat-wrapper { width: 100vw; min-height: 100vh; border-radius: 0; margin: 0; max-width: 100vw; max-height: 100vh;}
            .chat-header { font-size: 1.09rem; }
            #messages { max-height: 72vh; }
        }
    </style>
</head>
<body>
<div class="chat-wrapper">
    <div class="chat-header">
        <button class="chat-back" onclick="window.location.href='/chat/'" title="Sohbetlere geri dön">&#8592;</button>
        {% if other_user.avatar %}
            <img src="{{ other_user.avatar }}" class="chat-header-avatar" alt="Profil Foto">
        {% else %}
            <span class="chat-header-avatar" style="background:#ffab7b;color:#fff;display:flex;align-items:center;justify-content:center;">
                {{ other_user.name|first|upper }}
            </span>
        {% endif %}
        <div class="chat-header-info">
            <span class="chat-header-name">{{ other_user.name }}</span>
        </div>
    </div>
    <div id="messages"></div>
    <form id="sendMsg" class="chat-form" autocomplete="off">
        {% csrf_token %}
        <input type="hidden" name="chat_id" value="{{ chat_id }}">
        <input type="text" name="text" placeholder="Bir mesaj yazın..." required autocomplete="off">
        <button type="submit">Gönder</button>
    </form>
</div>
<script>
    var currentUser = "{{ request.session.user_email }}";
    function escapeHtml(text) {
        var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    function renderMessages(messages) {
        let msgDiv = document.getElementById("messages");
        msgDiv.innerHTML = "";
        if (messages.length === 0) {
            msgDiv.innerHTML = '<div style="text-align:center;color:#aaa;margin-top:30px;">Henüz mesaj yok.</div>';
            return;
        }
        messages.forEach(function(m) {
            let who = m.user_email === currentUser ? "me" : "them";
            let nameHtml = m.user_name && who !== "me" ? `<div class="msg-name">${escapeHtml(m.user_name)}</div>` : "";
            let avatar = m.avatar ? `<img src="${m.avatar}" class="msg-avatar" alt="pp">` : "";
            let bubble = `
                <div class="msg-row ${who}">
                    ${avatar}
                    <div>
                        ${nameHtml}
                        <div class="msg-bubble">${escapeHtml(m.text)}</div>
                    </div>
                </div>
            `;
            msgDiv.innerHTML += bubble;
        });
        // Otomatik kaydır (her zaman en alta)
        setTimeout(function(){
            msgDiv.scrollTop = msgDiv.scrollHeight;
        }, 100);
    }
    function loadMessages() {
        fetch("/chat/messages/{{ chat_id }}/")
        .then(r => r.json())
        .then(j => {
            if (j.success) {
                renderMessages(j.messages);
            }
        });
    }
    // İlk yüklemede ve her 2 sn'de bir mesajları çek
    loadMessages();
    setInterval(loadMessages, 2000);
    // Mesaj gönderme
    document.getElementById('sendMsg').onsubmit = function(e){
        e.preventDefault();
        var data = new FormData(this);
        fetch("/chat/send/", {
            method: "POST",
            body: data,
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(r => r.json())
        .then(j=>{
            if(j.success) {
                document.querySelector('input[name="text"]').value = "";
                loadMessages();
            }
        });
    }
</script>
</body>
</html>
